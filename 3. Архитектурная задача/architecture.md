# Архитектура системы для обслуживания 1200 email-адресов

## 1. Описание архитектуры

Система строится вокруг нескольких простых компонентов:

- **Почтовые домены и ящики** — для разных клиентов используются разные домены, что снижает риски блокировок.
- **Почтовый сервис (Mailgun/SendGrid/SMTP2GO)** — занимается отправкой писем, репутацией домена и даёт API/вебхуки.
- **n8n** — основной оркестратор, который выбирает адреса для отправки, следит за лимитами и обрабатывает события.
- **База данных (Supabase)** — хранит адреса, лимиты, логи отправок, статусы и настройки кампаний.
- **VPS** — минимальная инфраструктура: один сервер под n8n + при необходимости резервный.

---
## 2. Сервисы и используемые подходы

**Сервисы:**  
Mailgun/SendGrid/SMTP2GO (отправка и вебхуки), n8n (автоматизация), Supabase (БД), VPS, Telegram (уведомления).

**Подходы:**  
— несколько доменов для разделения рисков,  
— использование API-провайдеров,  
— хранение состояния в базе,  
— резервирование оркестратора.

---
## 3. Ротация и мониторинг

**Ротация:**  
Каждому адресу заданы лимиты. Перед отправкой n8n выбирает следующий доступный адрес (**round-robin**) с учётом его «здоровья» (нет ошибок, не превышены лимиты, нормальная статистика). Проблемные адреса временно исключаются.

**Мониторинг:**  
Почтовый сервис отправляет вебхуки («доставлено», «ошибка», «жалоба»). n8n сохраняет их в БД, обновляет статус адресов и отправляет алерты в Telegram/Slack.

---
## 4. Распределение нагрузки

Нагрузка распределяется:

1. **между клиентами** — у каждого свой пул адресов;
2. **между доменами** — если лимиты одного домена заканчиваются, используются другие;
3. **между email-адресами** — round-robin + учёт здоровья.

---
## 5. Риски и способы их закрытия

- Домен попадает в спам → несколько доменов, плавный прогрев, SPF/DKIM/DMARC, отключение проблемных адресов.
- Провайдер недоступен → использование двух разных почтовых сервисов.
- Падение n8n → резервный VPS/Docker.
- Потеря данных → автоматические бэкапы БД.
- Перегрузка адресов → лимиты + ротация + автоматическое охлаждение.

---
## 6. Стоимость инфраструктуры

| Компонент                                          | Цена/мес |
| -------------------------------------------------- | -------- |
| VPS под n8n                                        | 10–20 $  |
| Резервный VPS                                      | 10–15 $  |
| Supabase (Postgres)                                | ~25 $    |
| Почтовые провайдеры (SMTP2GO / Mailgun / SendGrid) | 15–35 $  |
| Домены (10–15 доменов)                             | ~10–15 $ |


Итого: ~70–110 $/мес при умеренной нагрузке
и до ~140–150 $/мес при росте объёмов.
