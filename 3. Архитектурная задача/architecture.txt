# Архитектура системы для обслуживания 1200 email-адресов

## 1. Описание архитектуры

Система строится вокруг простого и недорогого набора компонентов:

1. **Несколько почтовых доменов**  
	Для каждого клиента и направления выделяются отдельные домены/ящики — это снижает риск блокировки и повышает доставляемость.

2. **Почтовый сервис** (Mailgun, SendGrid или SMTP2GO)  
    Он занимается фактической отправкой писем, следит за репутацией домена, даёт API для отправок и вебхуки для получения статусов.

3. **Оркестратор n8n**  
    Управляет всей логикой:  
    — выбирает, каким адресом отправлять,  
    — контролирует лимиты,  
    — обрабатывает вебхуки,  
    — отключает проблемные адреса,  
    — отправляет алерты.

4. **База данных**  
    Служит «памятью» системы. В ней хранятся адреса, лимиты, статусы, логи отправок, настройки кампаний и статистика.
    
5. **Минимальная инфраструктура на VPS**  
    Один основной сервер под n8n + резервный для отказоустойчивости.

---
## 2. Сервисы и используемые подходы

### Сервисы:

- **Mailgun / SendGrid / SMTP2GO** — отправка email через API, вебхуки, управление доставкой.
- **n8n** — автоматизация отправок, обработка событий, ротация адресов.
- **Supabase** — хранение данных и логов.
- **VPS** — размещение n8n и небольших вспомогательных скриптов.
- **Telegram/Slack** — уведомления и алерты.
### Подходы:

- Разделение отправки на несколько доменов → снижение рисков спама.
- Использование API-провайдеров → стабильность и дешевизна.
- Хранение полного состояния в базе → система предсказуемая и управляемая.
- Лёгкая отказоустойчивость за счёт резервного инстанса n8n.
---
## 3. Как работает ротация и мониторинг

### Ротация адресов:

- Каждому адресу заданы лимиты: письма/день и письма/час.
- Перед отправкой n8n выбирает следующий адрес, который:  
    — не превысил лимиты,  
    — не имеет ошибок,  
    — находится в статусе «здоровый»,  
    — подходит под конкретного клиента.
- Отправка распределяется **по очереди**.
- Проблемные адреса автоматически исключаются из очереди.

### Мониторинг:

- Почтовые сервисы присылают вебхуки:  
    «доставлено», «отказ», «жалоба», «ответ».
- n8n сохраняет эти данные в базу.
- На основе метрик система:  
    — помечает адрес как «подозрительный»,  
    — отключает его при необходимости,  
    — отправляет уведомления в Telegram/Slack.
---

## 4. Как распределяется нагрузка

Нагрузка распределяется в несколько уровней:
### 1. Между клиентами и направлениями

Каждый клиент получает свой пул адресов → нет риска, что активность одного клиента посадит домен другого.

### 2. Между доменами

Если лимиты одного домена подходят к концу — письма уходят через остальные домены.

### 3. Между конкретными почтовыми адресами

Алгоритм round-robin + учёт их «здоровья» обеспечивает равномерное распределение нагрузки.

---

## 5. Риски и способы их закрытия

| Риск                            | Решение                                                                                          |
| ------------------------------- | ------------------------------------------------------------------------------------------------ |
| Домен попадает в спам           | Несколько доменов, плавный прогрев, SPF/DKIM/DMARC, автоматическое отключение проблемных адресов |
| Проблемы у почтового провайдера | Использование 2 провайдеров одновременно                                                         |
| Падение n8n                     | Docker + резервный VPS                                                                           |
| Потеря данных                   | Автоматические бэкапы базы                                                                       |
| Перегрузка адресов              | Лимиты + ротация + автоматическое охлаждение                                                     |
|                                 |                                                                                                  |

---

## 6. Примерная стоимость инфраструктуры

|Компонент|Стоимость в месяц|
|---|---|
|VPS под n8n|10–20 $|
|Резервный VPS|10–15 $|
|Postgres / Supabase|25–40 $|
|Почтовые провайдеры|50–100 $|
|Домены (10–15 штук)|~10–15 $|

**Итого: ≈ 100–180 $/месяц** при 1200 отправителях и высокой отказоустойчивости.